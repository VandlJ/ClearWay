name: Development CI Pipeline

on:
  push:
    branches: [ dev ]
  pull_request:
    branches: [ dev ]

jobs:
  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Lint check
        working-directory: ./frontend
        run: npm run lint
        
      - name: Install Jest and testing libraries
        working-directory: ./frontend
        run: npm install --save-dev jest @testing-library/react @testing-library/jest-dom jest-environment-jsdom @types/jest jest-fetch-mock

      - name: Create Jest config
        working-directory: ./frontend
        run: |
          cat > jest.config.js << 'EOL'
          module.exports = {
            testEnvironment: 'jsdom',
            testMatch: ['**/__tests__/**/*.test.{js,jsx,ts,tsx}'],
            setupFilesAfterEnv: ['<rootDir>/__tests__/setup.js'],
            moduleNameMapper: {
              '^@/(.*)$': '<rootDir>/src/$1',
              '^leaflet$': '<rootDir>/__mocks__/leafletMock.js',
              '\\.(css|less)$': '<rootDir>/__mocks__/styleMock.js',
            },
            transform: {
              '^.+\\.(ts|tsx|js|jsx)$': ['babel-jest', { presets: ['next/babel'] }]
            }
          };
          EOL
          
          # Add Jest script to package.json
          npx json -I -f package.json -e 'this.scripts.test = "jest"'
          
          # Create test setup file
          mkdir -p __tests__
          cat > __tests__/setup.js << 'EOL'
          import '@testing-library/jest-dom'
          import { enableFetchMocks } from 'jest-fetch-mock'
          
          enableFetchMocks()
          
          // Mock next/dynamic
          jest.mock('next/dynamic', () => () => {
            const DynamicComponent = () => null;
            DynamicComponent.displayName = 'LoadableComponent';
            return DynamicComponent;
          });
          
          // Mock localStorage
          const localStorageMock = (function() {
            let store = {};
            return {
              getItem: jest.fn(key => store[key] || null),
              setItem: jest.fn((key, value) => {
                store[key] = value.toString();
              }),
              clear: jest.fn(() => {
                store = {};
              }),
              removeItem: jest.fn(key => {
                delete store[key];
              })
            };
          })();
          
          Object.defineProperty(window, 'localStorage', {
            value: localStorageMock
          });
          EOL
          
          # Create mocks directory and mock files
          mkdir -p __mocks__
          
          # Create leaflet mock
          cat > __mocks__/leafletMock.js << 'EOL'
          const L = {
            map: jest.fn(() => ({
              setView: jest.fn(),
              remove: jest.fn()
            })),
            tileLayer: jest.fn(() => ({
              addTo: jest.fn()
            })),
            marker: jest.fn(() => ({
              addTo: jest.fn()
            })),
            divIcon: jest.fn(() => ({})),
            icon: jest.fn(() => ({}))
          };
          
          module.exports = L;
          EOL
          
          # Create style mock
          cat > __mocks__/styleMock.js << 'EOL'
          module.exports = {};
          EOL

      - name: Create frontend tests
        working-directory: ./frontend
        run: |
          # Create dataService test
          cat > __tests__/dataService.test.js << 'EOL'
          import { fetchGPSDataMin, fetchGPSDataMax, fetchOptions, sendFileToBackend } from '@/service/dataService';
          import fetchMock from 'jest-fetch-mock';
          
          beforeEach(() => {
            fetchMock.resetMocks();
          });
          
          describe('Data Service Tests', () => {
            test('fetchGPSDataMin fetches data successfully', async () => {
              const mockData = [{ gps: { n: 49.7475, e: 13.3776 }, size: 300 }];
              fetchMock.mockResponseOnce(JSON.stringify(mockData));
              
              const result = await fetchGPSDataMin('testDataset');
              
              expect(fetchMock).toHaveBeenCalledWith('https://storagegrid.eu/api/data/reduced/min/testDataset');
              expect(result).toEqual(mockData);
            });
            
            test('fetchGPSDataMax fetches data successfully', async () => {
              const mockData = [{ gps: { n: 49.7475, e: 13.3776 }, size: 400 }];
              fetchMock.mockResponseOnce(JSON.stringify(mockData));
              
              const result = await fetchGPSDataMax('testDataset');
              
              expect(fetchMock).toHaveBeenCalledWith('https://storagegrid.eu/api/data/reduced/max/testDataset');
              expect(result).toEqual(mockData);
            });
            
            test('fetchOptions returns available datasets', async () => {
              const mockOptions = ['dataset1', 'dataset2'];
              fetchMock.mockResponseOnce(JSON.stringify(mockOptions));
              
              const result = await fetchOptions();
              
              expect(fetchMock).toHaveBeenCalledWith('https://storagegrid.eu/api/data/options');
              expect(result).toEqual(mockOptions);
            });
            
            test('sendFileToBackend uploads file correctly', async () => {
              const mockResponse = { success: true };
              fetchMock.mockResponseOnce(JSON.stringify(mockResponse));
              
              const file = new File(['test content'], 'test.csv', { type: 'text/csv' });
              const result = await sendFileToBackend(file);
              
              expect(fetchMock).toHaveBeenCalledWith('https://storagegrid.eu/api/add', expect.any(Object));
              expect(result).toEqual(mockResponse);
            });
          });
          EOL
          
          # Create simple component test
          cat > __tests__/DatasetContext.test.js << 'EOL'
          import { render, screen, act } from '@testing-library/react';
          import { DatasetProvider, useDataset } from '@/app/providers/DatasetContextProvider';
          
          // Create a test component that uses the context
          const TestComponent = () => {
            const { selectedDataset, setSelectedDataset } = useDataset();
            
            return (
              <div>
                <div data-testid="selected-dataset">{selectedDataset}</div>
                <button 
                  data-testid="change-dataset" 
                  onClick={() => setSelectedDataset('newDataset')}
                >
                  Change Dataset
                </button>
              </div>
            );
          };
          
          describe('DatasetContext Tests', () => {
            test('provides default context values', () => {
              render(
                <DatasetProvider>
                  <TestComponent />
                </DatasetProvider>
              );
              
              // Default dataset should be an empty string
              expect(screen.getByTestId('selected-dataset').textContent).toBe('');
            });
            
            test('allows changing the selected dataset', () => {
              render(
                <DatasetProvider>
                  <TestComponent />
                </DatasetProvider>
              );
              
              // Click the button to change the dataset
              act(() => {
                screen.getByTestId('change-dataset').click();
              });
              
              // Dataset should have changed
              expect(screen.getByTestId('selected-dataset').textContent).toBe('newDataset');
            });
          });
          EOL
      
      - name: Run unit tests
        working-directory: ./frontend
        run: npm test

  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./backend
        run: npm ci
      
      - name: Install testing libraries
        working-directory: ./backend
        run: npm install --save-dev jest supertest

      - name: Create backend tests
        working-directory: ./backend
        run: |
          mkdir -p __tests__
          cat > __tests__/server.test.js << 'EOL'
          const request = require('supertest');
          const express = require('express');
          const cors = require('cors');
          
          // Create a simplified version of your actual server for testing
          const app = express();
          app.use(cors());
          app.use(express.json());
          
          // Mock endpoints based on your actual backend functionality
          app.get('/api/data/options', (req, res) => {
            res.json(['dataset1', 'dataset2']);
          });
          
          app.get('/api/data/reduced/min/:dataset', (req, res) => {
            const { dataset } = req.params;
            res.json([
              { gps: { n: 49.7475, e: 13.3776 }, size: 300 }
            ]);
          });
          
          app.get('/api/data/reduced/max/:dataset', (req, res) => {
            const { dataset } = req.params;
            res.json([
              { gps: { n: 49.7475, e: 13.3776 }, size: 400 }
            ]);
          });
          
          describe('API Endpoints', () => {
            it('GET /api/data/options returns available datasets', async () => {
              const response = await request(app).get('/api/data/options');
              expect(response.statusCode).toBe(200);
              expect(response.body).toEqual(['dataset1', 'dataset2']);
            });
            
            it('GET /api/data/reduced/min/:dataset returns min GPS data', async () => {
              const response = await request(app).get('/api/data/reduced/min/test');
              expect(response.statusCode).toBe(200);
              expect(response.body).toEqual([
                { gps: { n: 49.7475, e: 13.3776 }, size: 300 }
              ]);
            });
            
            it('GET /api/data/reduced/max/:dataset returns max GPS data', async () => {
              const response = await request(app).get('/api/data/reduced/max/test');
              expect(response.statusCode).toBe(200);
              expect(response.body).toEqual([
                { gps: { n: 49.7475, e: 13.3776 }, size: 400 }
              ]);
            });
          });
          EOL
          
          # Update package.json script
          npx json -I -f package.json -e 'this.scripts.test = "jest"'
      
      - name: Run unit tests
        working-directory: ./backend
        run: npm test

  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: [frontend-tests, backend-tests]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Cypress and create package.json
        run: |
          npm init -y
          npm install cypress --save-dev
      
      - name: Create Cypress tests
        run: |
          mkdir -p cypress/e2e cypress/fixtures
          
          # Create Cypress config
          cat > cypress.config.js << 'EOL'
          const { defineConfig } = require('cypress');
          
          module.exports = defineConfig({
            e2e: {
              setupNodeEvents(on, config) {},
              baseUrl: 'http://localhost:3000',
            },
          });
          EOL
          
          # Create map tests
          cat > cypress/e2e/map.cy.js << 'EOL'
          describe('Map Page', () => {
            beforeEach(() => {
              // Mock API response for dataset options
              cy.intercept('GET', 'https://storagegrid.eu/api/data/options', {
                statusCode: 200,
                body: ['dataset1', 'dataset2']
              }).as('getOptions');
              
              // Mock API response for GPS data
              cy.intercept('GET', 'https://storagegrid.eu/api/data/reduced/**', {
                statusCode: 200,
                body: [
                  { gps: { n: 49.7475, e: 13.3776 }, size: 300 }
                ]
              }).as('getGPSData');
              
              // Visit the map page
              cy.visit('/map');
            });
            
            it('displays the map component', () => {
              // Check if map is rendered
              cy.get('.leaflet-container').should('exist');
            });
            
            it('shows dataset selection dropdown', () => {
              cy.wait('@getOptions');
              cy.get('select').should('exist');
              cy.get('select option').should('have.length.at.least', 2);
            });
            
            it('allows changing vehicle width', () => {
              const testWidth = '250';
              cy.get('input[type="number"]').clear().type(testWidth);
              cy.get('input[type="number"]').should('have.value', testWidth);
            });
          });
          EOL
          
          # Create navigation tests
          cat > cypress/e2e/navigation.cy.js << 'EOL'
          describe('Navigation', () => {
            beforeEach(() => {
              cy.visit('/');
            });
            
            it('navigates to map page', () => {
              cy.get('a[href*="map"]').click();
              cy.url().should('include', '/map');
            });
            
            it('changes locale', () => {
              cy.get('[data-testid="locale-switch"]').click();
              cy.get('[data-testid="locale-option-cs"]').click();
              cy.url().should('include', '/cs');
            });
          });
          EOL
      
      - name: Run Cypress tests (mock mode)
        run: |
          echo "In a real CI environment, we would start the frontend and backend servers"
          echo "Then run Cypress with: npx cypress run"
          echo "For now, we'll verify the tests are valid with: npx cypress validate"
          npx cypress validate